import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.DgDu2bHw.js";const E=JSON.parse('{"title":"middleware","description":"","frontmatter":{},"headers":[],"relativePath":"NuxtDocs/CoreEssentials/DirectoryStructure/middleware.md","filePath":"NuxtDocs/CoreEssentials/DirectoryStructure/middleware.md"}'),p={name:"NuxtDocs/CoreEssentials/DirectoryStructure/middleware.md"};function t(h,s,e,k,F,r){return n(),a("div",null,s[0]||(s[0]=[l(`<h1 id="middleware" tabindex="-1">middleware <a class="header-anchor" href="#middleware" aria-label="Permalink to &quot;middleware&quot;">​</a></h1><details class="details custom-block"><summary>理论阐述</summary><p><strong>1. 什么是 middleware 目录？</strong></p><blockquote><ul><li><code>middleware</code> 目录用于存放路由中间件文件。这些文件在页面渲染前执行，可拦截路由、修改请求/响应、执行认证检查等操作。中间件在服务端和客户端均可运行。</li></ul></blockquote><hr><p><strong>2. 有什么用？</strong></p><blockquote><ul><li><strong>路由守卫</strong>：控制页面访问权限</li><li><strong>全局逻辑</strong>：执行跨页面共享的逻辑</li><li><strong>数据预处理</strong>：提前获取页面所需数据</li><li><strong>请求修改</strong>：修改请求头或响应头</li><li><strong>错误处理</strong>：统一处理路由错误</li></ul></blockquote><hr><p><strong>3. 常见使用场景</strong></p><blockquote><ul><li><strong>用户身份验证</strong></li><li><strong>权限控制</strong></li><li><strong>日志记录</strong></li><li><strong>A/B测试</strong></li><li><strong>地理定位检查</strong></li><li><strong>维护模式切换</strong></li></ul></blockquote><hr><p><strong>4. 目录结构建议</strong></p><blockquote><p>当然在实际开发的项目中是由具体的项目而定，这里只是给个参考</p></blockquote><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span>middleware/</span></span>
<span class="line"><span>  ├── auth.global.ts    # 全局中间件（自动运行）</span></span>
<span class="line"><span>  ├── admin.ts          # 管理员权限检查</span></span>
<span class="line"><span>  ├── guest.ts          # 访客限制</span></span>
<span class="line"><span>  ├── log.ts            # 访问日志记录</span></span>
<span class="line"><span>  └── maintenance.ts    # 维护模式检查</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><p><strong>5. 需要引入才能使用吗？</strong></p><blockquote><ul><li><strong>全局中间件</strong>（<code>.global</code>后缀）自动应用于所有路由</li><li><strong>命名中间件</strong>需要在页面中通过 <code>definePageMeta</code> 显式调用</li></ul></blockquote><hr><p><strong>6. 与插件（plugins）的区别：</strong></p><table tabindex="0"><thead><tr><th><strong>特性</strong></th><th><strong>middleware</strong></th><th><strong>plugins</strong></th></tr></thead><tbody><tr><td>执行时机</td><td>路由导航前（客户端或服务端）</td><td>Nuxt应用初始化时（客户端和服务端）</td></tr><tr><td>使用场景</td><td>路由相关的逻辑</td><td>应用初始化、全局功能注入</td></tr><tr><td>访问上下文</td><td>访问路由对象 (to, from)</td><td>访问Nuxt应用实例</td></tr><tr><td>多次执行</td><td>每次路由变化</td><td>仅一次（或每次热更新）</td></tr></tbody></table><hr><p><strong>7. 配置相关：</strong></p><p>在 <mark>nuxt.config.ts</mark> 中可配置中间件行为：</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtConfig</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">  routeRules</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">    &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/admin/**</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> </span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">      middleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">auth</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">admin</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">] </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 路由级中间件</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr></details><details class="details custom-block"><summary>代码示例</summary><p><strong>1. 全局身份验证中间件</strong></p><p><strong><code>/middleware/auth.global.ts</code></strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> isAuthenticated</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> useAuthStore</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  </span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">  // 重定向到登录页</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">isAuthenticated</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> !</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">path</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">startsWith</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/login</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> navigateTo</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/login?redirect=</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> +</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">fullPath</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  </span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">  // 已登录时禁止访问登录页</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">isAuthenticated</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> &amp;&amp;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">path</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> ===</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/login</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> navigateTo</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/dashboard</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><hr><p><strong>2. 命名中间件（管理员检查）</strong></p><p><strong><code>/middleware/admin.ts</code></strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> user</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> useUserStore</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  </span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">user</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">isAdmin</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">    // 中止导航并显示错误</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> abortNavigation</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">      statusCode</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#B48EAD;"> 403</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">      message</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">Requires admin privileges</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在页面中使用：</p><div class="language-vue vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> setup</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  definePageMeta</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#88C0D0;">    middleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">admin</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">] </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 使用中间件</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">script</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><p><strong>3. 维护模式中间件</strong></p><p><strong><code>/middleware/maintenance.ts</code></strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> maintenanceMode</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> useRuntimeConfig</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">public</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  </span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">maintenanceMode</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">    // 重定向到维护页面</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> navigateTo</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/maintenance</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> redirectCode</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#B48EAD;"> 503</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><p><strong>4. 异步数据预取</strong></p><p><strong><code>/middleware/data-prefetch.ts</code></strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">async</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> productId</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">params</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">id</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">productId</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">    // 预取产品数据</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> useProductStore</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">fetchProduct</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">productId</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> as</span><span style="--shiki-light:#1976D2;--shiki-dark:#8FBCBB;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><p><strong>5. 多中间件组合使用</strong></p><div class="language-vue vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> setup</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  definePageMeta</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#88C0D0;">    middleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> [</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">      &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">auth</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">    // 先验证登录</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">      &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">admin</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">   // 再验证管理员权限</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">      &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">log</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">      // 最后记录访问日志</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">script</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr></details><details class="details custom-block"><summary>问题补充</summary><p><strong>1. 执行顺序规则</strong></p><blockquote><ul><li>1: 全局中间件（按文件名顺序）</li><li>2: 布局（layout）中定义的中间件</li><li>3: 页面中定义的中间件</li></ul></blockquote><hr><p><strong>2. 服务端 vs 客户端执行</strong></p><blockquote><ul><li><strong>首次访问</strong>：在服务端执行</li><li><strong>客户端导航</strong>：在客户端执行</li><li><strong>强制服务端执行</strong>：</li></ul></blockquote><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">server</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">      // 仅服务端逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><p><strong>3. 动态添加中间件</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 在插件或组件中动态添加</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">addRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">tracking</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  useTrackPageView</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">path</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> global</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#81A1C1;"> true</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr><p><strong>4. 错误处理最佳实践</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">    try</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">      // 业务逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">    }</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> catch</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">      // 统一错误处理</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">      showError</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">        statusCode</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#B48EAD;"> 500</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">        message</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">Middleware error</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">      }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">      // 或中止导航</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> abortNavigation</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><hr><p><strong>5. 中间件类型定义</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 增强类型安全</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> MiddlewareContext</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  to</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> RouteLocationNormalized</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">  from</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> RouteLocationNormalized</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  next</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">?:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> ()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#8FBCBB;"> void</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">context</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;"> MiddlewareContext</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">  // 逻辑处理</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr><p><strong>6. 性能优化建议</strong></p><blockquote><ul><li>避免在中间件中执行重型同步操作</li><li>对数据预取使用 <code>lazy: true</code> 选项</li><li>使用 <code>watch: false</code> 防止重复执行：</li></ul></blockquote><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">definePageMeta</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">  middleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">auth</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> path</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/dashboard</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> watch</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#81A1C1;"> false</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><p><strong>7. 性能优化建议</strong></p><p>1.<strong>命名规范：</strong></p><blockquote><ul><li>全局中间件：[name].global.ts</li><li>局部中间件：[name].ts</li></ul></blockquote><p>2.<strong>安全实践：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 防止敏感信息泄露</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">client</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">  deleteHeaders</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">([</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">X-Secret-Token</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">])</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>3.<strong>中间件复用：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 创建可配置中间件</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> createAuthMiddleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> (</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">options</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">to</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">    // 使用options配置</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>4.<strong>组合式函数集成：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 复用组合式逻辑</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">export</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> defineNuxtRouteMiddleware</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  const</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;"> validate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> }</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> useAuth</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> validate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>5.<strong>避免副作用：</strong></p><blockquote><ul><li>不要在中间件中直接修改组件状态</li><li>通过状态管理（Pinia）共享数据</li></ul></blockquote><hr><p><strong>8. 常见错误</strong></p><p>1.<strong>循环重定向：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 错误示例：未设置排除路径</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">!</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">isAuth</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> navigateTo</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/login</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2.<strong>服务端客户端不一致：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 错误：在服务端使用window</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">window</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#D8DEE9;">localStorage</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">token</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// ❌</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>3.<strong>未处理异步：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 错误：未等待异步操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">fetchData</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">() </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// ❌ 可能未完成就继续导航</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.<strong>路径硬编码：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// 错误</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">navigateTo</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">/en/login</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">) </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// ❌ 应使用i18n路径</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>5.<strong>中间件顺序错误：</strong></p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes min-light nord vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">definePageMeta</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">(</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">{</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">  middleware</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">log</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">auth</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">] </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;">// ❌ 应先执行auth</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr></details>`,4)]))}const g=i(p,[["render",t]]);export{E as __pageData,g as default};
